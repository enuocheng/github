### 一、二进制原码、反码、补码 介绍
### 机器数和真值

### 一个数在计算机中的二进制表示形式,  叫做这个数的机器数。
### 将带符号位的机器数对应的真正数值称为机器数的真值。

### 二、 原码, 反码, 补码的基础概念和计算方法

### 三、 为何要使用原码, 反码和补码

### 1的原码、反码、补码

1（正数三码相同）的二进制原码

00000000 00000000 00000000 00000001 

1的二进制反码

00000000 00000000 00000000 00000001

1的二进制补码

00000000 00000000 00000000 00000001

### -1的二进制原码、反码、补码
-1的二进制原码

10000000 00000000 00000000 00000001
 
-1的二进制反码

11111111 11111111 11111111 11111110

-1的二进制补码

11111111 11111111 11111111 11111111

### SnowFlake算法Id64bit表示


![](https://img-blog.csdn.net/20170331143349041?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvdTAxMDM3Mjk4MQ==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast)

### SnowFlake算法Id64bit各部分说明

1位，表示符号最高位固定是0

41位，用来记录时间戳（毫秒）。
41位可以表示2的41次幂−1个数字，也就是说41位可以表示2的41次幂−1个毫秒的值，转化成单位年则是(2的41次幂−1)/(1000∗60∗60∗24∗365)=69年

10位，用来记录工作机器id。
可以部署在2的10次幂=1024个节点，包括5位datacenterId和5位workerId
5位（bit）可以表示的最大正整数是25−1=31，即可以用0、1、2、3、....31这32个数字，来表示不同的datecenterId或workerId

12位，序列号，用来记录同毫秒内产生的不同id。
12位（bit）可以表示的最大正整数是2的12次幂−1=4095，即可以用0、1、2、3、....4094这4095个数字，来表示同一机器同一时间截（毫秒)内产生的4095个ID序号，1秒能生成400W条id

### SnowFlake算法解读



参照：com.fanhaoyue.algorithm.SnowFlake 类


``` 
    #### `运行结果`
    时间戳时间：30462770903
                             |<--左移22位
    0|0000000 00000000 00000000 00000111 00010111 10|111000 11111110 11010111 
    0|0000001 11000101 11101110 00111111 10110101 11|000000 00000000 00000000 
                                                     |-->后面补0
    datacenterId：5
                       |<--左移17位
    0|0000000 00000000 00000000 00000000 00000000 00|00000|0 0000|0000 00000101 
    0|0000000 00000000 00000000 00000000 00000000 00|00101|0 0000|0000 00000000 
                                                           |-->后面补0
    workerId：3
                 |<--左移12位
    0|0000000 00000000 00000000 00000000 00000000 00|00000|0 0000|0000 00000011 
    0|0000000 00000000 00000000 00000000 00000000 00|00000|0 0011|0000 00000000 
                                                                  |-->后面补0
    sequence：0
    00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000 
    
    由以上4个数据进行或运算
    0|0000001 11000101 11101110 00111111 10110101 11|00000|0 0000|0000 00000000 
    0|0000000 00000000 00000000 00000000 00000000 00|00101|0 0000|0000 00000000 
    0|0000000 00000000 00000000 00000000 00000000 00|00000|0 0011|0000 00000000 
    0|0000000 00000000 00000000 00000000 00000000 00|00000|0 0000|0000 00000000 
    OR--------------------------------------------------------------------------
    0|0000001 11000101 11101110 00111111 10110101 11|00101|0 0011|0000 00000000 
    
    最后计算结果
    ID：127770121850204160
```


### SnowFlake应用场景
1、分库、分表

2、分布式环境下、全局唯一性id

3、高并发环环境每秒要百万级id

4、高可用、高性能的id

### SnowFlake和UUID比较

相同：
同样是内存生成，不需要依赖数据库等其他东西
同样满足分布式唯一

不同： uuid 无序，snowflake 趋势递增 snowflake 个适合作为数据库的主键（索引？） snowflake 时间回拨时，有可能发生重复

### SnowFlake算法优点
高可用，短ID服务允许部署多套完全独立的环境，每个环境产生的ID都不一样，client可以failover到任何环境

高性能，每秒钟可以获取百万级的ID，并且不会出现阻塞

基于时间的大致有序，基本上获取到的ID会越来越大，无法保证严格有序，比如一小时前获取的ID应该会比一小时后的小
一致性，绝对保证不会获取到重复的ID（服务端保证）

### 根据算法规则结合公司的业务场景

根据自己业务修改每个位段存储的信息。算法是通用的，可以根据自己需求适当调整每段的大小以及存储的信息。
解密id，由于id的每段都保存了特定的信息，所以拿到一个id，应该可以尝试反推出原始的每个段的信息。反推出的信息可以帮助我们分析。比如作为订单，可以知道该订单的生成日期，负责处理的数据中心等等。


### SnowFlake思考和不足
1、由于服务器时间并不是完全同步，所以虽然对单台服务器来说ID是递增的，但不同服务器间生成的ID并不是随时间递增的。

2、服务器时间回拨

3、无法保证严格全局有序

4、无法保证按照时间有序

5、无法保证每个ID都不浪费

### 解决方案

回拨后使用不同的机器Id（可能是个集群，有机器可以选择）

停止服务一段时间，比如回拨100ms，则服务停止100ms（这种情况大生产阻塞）

以上不是最好的解决方案

Flame-client方案：
http://k.2dfire.net/pages/viewpage.action?pageId=295043535
通过zk 存最近的一个游标（ cursor ）作为最新的时间节点

美团：leaf
https://tech.meituan.com/MT_Leaf.html



### 参考

[http://chuansong.me/n/2459549](http://chuansong.me/n/2459549)
[https://www.jianshu.com/p/2e57acbe4a19](https://www.jianshu.com/p/2e57acbe4a19)
[https://blog.csdn.net/u010372981/article/details/68924830](https://blog.csdn.net/u010372981/article/details/68924830)
[https://segmentfault.com/a/1190000011282426](https://segmentfault.com/a/1190000011282426)
[http://k.2dfire.net/pages/viewpage.action?pageId=295043535](http://k.2dfire.net/pages/viewpage.action?pageId=295043535)
[https://tech.meituan.com/MT_Leaf.html](https://tech.meituan.com/MT_Leaf.html)